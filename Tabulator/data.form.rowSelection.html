<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabulator: data.form.rowSelection</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/6.3.1/css/tabulator.min.css" rel="stylesheet" />
</head>
<body>
    <form id="formA" method="post">
        <label>Date From: <input name="date_from" type="date"></label>
        <label>Date To: <input name="date_to" type="date"></label>
        <div id="tabulator-table"></div>
        <button type="submit">Submit</button>
    </form>
    <button type="button" id="show-local-storage">View Local Storage</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/6.3.1/js/tabulator.min.js"></script>
    <script>
        const appState = {
            tabulatorSelectedItems: []
        };

        const table = new Tabulator("#tabulator-table", {
            ajaxURL: "../assets/ISO-4217.json",
            ajaxConfig: "GET",
            selectable: true,
            columns: [
                {
                    cellClick: (e, cell) => cell.getRow().toggleSelect(),
                    formatter: "rowSelection",
                    headerClick: (e, column) => {
                        // Optional: Handle clicks on header cell (not checkbox)
                        const tableInstance = column.getTable();
                        const allRows = tableInstance.getRows();
                        const allSelected = allRows.every(row => row.isSelected());

                        if (allSelected) {
                            allRows.forEach(row => row.deselect());
                        } else {
                            allRows.forEach(row => row.select());
                        }

                        formsCacheDataToLocalStorage();
                    },
                    headerSort: false,
                    hozAlign: "center",
                    titleFormatter: "rowSelection",
                    width: 80
                },
                { field: "code", title: "Code", width: 80 },
                { field: "currency", title: "Currency" },
                { field: "digits", title: "Digits", width: 80 },
                { field: "numeric", title: "Numeric", width: 80 },
                { field: "locations", title: "Locations" }
            ],
            layout: "fitColumns",
            pagination: true,
            paginationMode: "local",
            paginationSize: 10,
        });

        function mergeArraysUnique(arr1, arr2) {
            return Array.from(new Set([...(arr1 || []), ...(arr2 || [])]));
        }

        function formsCacheDataToLocalStorage() {
            const currentLocalStorage = JSON.parse(localStorage.getItem('forms') || '{}');
            const form = document.querySelector('#formA');
            const formData = new FormData(form);
            const collectedData = {};

            for (const [name, value] of formData.entries()) {
                const isArrayInput = name.endsWith('[]');
                const key = isArrayInput ? name.slice(0, -2) : name;
                if (isArrayInput) {
                    if (!collectedData[key]) {
                        collectedData[key] = [];
                    }
                    collectedData[key].push(value);
                } else {
                    collectedData[key] = value;
                }
            }

            const keyForTabulatorItems = 'items';
            collectedData[keyForTabulatorItems] = [...new Set(appState.tabulatorSelectedItems)];

            for (const [key, value] of Object.entries(collectedData)) {
                if (Array.isArray(value)) {
                    currentLocalStorage[key] = mergeArraysUnique(currentLocalStorage[key], value);
                } else {
                    currentLocalStorage[key] = value;
                }
            }

            localStorage.setItem('forms', JSON.stringify(currentLocalStorage));
            console.log('Form data cached:', currentLocalStorage);
        }

        function setupEventHandlers() {
            // Handle row selection changes (including header checkbox)
            table.on("rowSelectionChanged", (data, rows) => {
                // Update appState.tabulatorSelectedItems with the codes of selected rows
                appState.tabulatorSelectedItems = rows
                    .map(row => row.getData().code)
                    .filter(code => code); // Ensure no undefined codes

                // Update local storage
                formsCacheDataToLocalStorage();
            });

            // Optional: Keep rowSelected for individual row clicks (if needed)
            table.on("rowSelected", row => {
                const rowData = row.getData();
                if (rowData.code && !appState.tabulatorSelectedItems.includes(rowData.code)) {
                    appState.tabulatorSelectedItems.push(rowData.code);
                    formsCacheDataToLocalStorage();
                }
            });

            // Optional: Keep rowDeselected for individual row clicks (if needed)
            table.on("rowDeselected", row => {
                const rowData = row.getData();
                if (rowData.code) {
                    appState.tabulatorSelectedItems = appState.tabulatorSelectedItems.filter(item => item !== rowData.code);
                    formsCacheDataToLocalStorage();
                }
            });

            // Listen for cell edits
            table.on("cellEdited", () => {
                formsCacheDataToLocalStorage();
            });

            // Listen for row additions
            table.on("rowAdded", () => {
                formsCacheDataToLocalStorage();
            });

            // Form submission
            document.querySelector('#formA').addEventListener('submit', event => {
                event.preventDefault(); // Prevent default form submission
                formsCacheDataToLocalStorage();
            });

            // Page change
            table.on("pageLoaded", formsCacheDataToLocalStorage);

            // Show localStorage content
            document.getElementById('show-local-storage').addEventListener('click', () => {
                const savedData = localStorage.getItem('forms');
                if (savedData) {
                    alert('form_data\n' + savedData);
                } else {
                    alert('No form_data found in localStorage');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupEventHandlers();
        });
    </script>
</body>
</html>