<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabulator: data.form.rowSelection</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/6.3.1/css/tabulator.min.css" rel="stylesheet" />
</head>
<body>
    <form id="formA" method="post">
        <label>Date From: <input name="date_from" type="date"></label>
        <label>Date To: <input name="date_to" type="date"></label>
        <div id="tabulator-table"></div>
        <button type="submit">Submit</button>
    </form>
    <button type="button" id="show-local-storage">View Local Storage</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/6.3.1/js/tabulator.min.js"></script>
    <script>
        // Tabulator row selection name
        const tableRowSelectName = 'items';

        const table = new Tabulator("#tabulator-table", {
            ajaxURL: "../assets/ISO-4217.json",
            ajaxConfig: "GET",
            selectable: true,
            columns: [
                {
                    cellClick: (e, cell) => cell.getRow().toggleSelect(),
                    formatter: "rowSelection",
                    headerClick: (e, column) => {
                        const tableInstance = column.getTable();
                        const allRows = tableInstance.getRows();
                        const allSelected = allRows.every(row => row.isSelected());
                        if (allSelected) {
                            allRows.forEach(row => row.deselect());
                        } else {
                            allRows.forEach(row => row.select());
                        }
                    },
                    headerSort: false,
                    hozAlign: "center",
                    titleFormatter: "rowSelection",
                    width: 80
                },
                { field: "code", title: "Code", width: 80 },
                { field: "currency", title: "Currency" },
                { field: "digits", title: "Digits", width: 80 },
                { field: "numeric", title: "Numeric", width: 80 },
                { field: "locations", title: "Locations" }
            ],
            layout: "fitColumns",
            pagination: true,
            paginationMode: "local",
            paginationSize: 10,
        });

        function mergeArraysUnique(arr1, arr2) {
            return Array.from(new Set([...(arr1 || []), ...(arr2 || [])]));
        }

        function formsCacheDataToLocalStorage() {
            const currentLocalStorage = JSON.parse(localStorage.getItem('forms') || '{}');
            const form = document.querySelector('#formA');
            const formData = new FormData(form);
            const collectedData = {};
            const dynamicKeys = [];

            for (const [name, value] of formData.entries()) {
                const isArrayInput = name.endsWith('[]');
                const key = isArrayInput ? name.slice(0, -2) : name;
                if (isArrayInput) {
                    if (!collectedData[key]) {
                        collectedData[key] = [];
                    }
                    collectedData[key].push(value);
                    if (!dynamicKeys.includes(key)) {
                        dynamicKeys.push(key);
                    }
                } else {
                    collectedData[key] = value;
                }
            }

            // Get selected items from Tabulator
            const selectedTabulatorItems = table.getSelectedData().map(row => row.code);

            // Add Tabulator items to the collected data and mark as dynamic
            if (!collectedData[tableRowSelectName]) {
                collectedData[tableRowSelectName] = [];
            }
            collectedData[tableRowSelectName] = mergeArraysUnique(collectedData[tableRowSelectName], selectedTabulatorItems);
            if (!dynamicKeys.includes(tableRowSelectName)) {
                dynamicKeys.push(tableRowSelectName);
            }

            // Add the new dynamic key to the collected data
            collectedData['_inputDynamic'] = dynamicKeys;

            // Merge with existing localStorage data
            for (const [key, value] of Object.entries(collectedData)) {
                if (Array.isArray(value)) {
                    currentLocalStorage[key] = mergeArraysUnique(currentLocalStorage[key], value);
                } else {
                    currentLocalStorage[key] = value;
                }
            }

            // Clear dynamic arrays that are no longer selected
            const previouslyDynamicKeys = currentLocalStorage['_inputDynamic'] || [];
            for (const key of previouslyDynamicKeys) {
                if (!collectedData[key] || collectedData[key].length === 0) {
                    delete currentLocalStorage[key];
                }
            }
            currentLocalStorage['_inputDynamic'] = dynamicKeys;

            localStorage.setItem('forms', JSON.stringify(currentLocalStorage));
            console.log('Form data cached:', currentLocalStorage);
        }

        function setupEventHandlers() {
            // This is the most reliable event to track all selection/deselection changes
            table.on("rowSelectionChanged", () => {
                formsCacheDataToLocalStorage();
            });

            table.on("cellEdited", () => {
                formsCacheDataToLocalStorage();
            });

            table.on("rowAdded", () => {
                formsCacheDataToLocalStorage();
            });

            document.querySelector('#formA').addEventListener('submit', event => {
                event.preventDefault();
                formsCacheDataToLocalStorage();
            });

            table.on("pageLoaded", () => {
                // When the page loads, we get the up-to-date selected data
                formsCacheDataToLocalStorage();
            });

            document.getElementById('show-local-storage').addEventListener('click', () => {
                const savedData = localStorage.getItem('forms');
                if (savedData) {
                    alert('form_data\n' + savedData);
                } else {
                    alert('No form_data found in localStorage');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupEventHandlers();
        });
    </script>
</body>
</html>