<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabulator: data.form.clone</title>
    <!-- Tabulator CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/6.3.1/css/tabulator.min.css"
        integrity="sha512-RYFH4FFdhD/FdA+OVEbFVqd5ifR+Dnx2M7eWcmkcMexlIoxNgm89ieeVyHYb8xChuYBtbrasMTlo02cLnidjtQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" rel="stylesheet" />
</head>

<body>
    <form action="submit.php" method="post" name="formA">
        <label>Date From: <input name="date_from" type="date"></label>
        <label>Date To: <input name="date_to" type="date"></label>
        <div id="tabulator-table"></div>
        <button type="submit">Submit</button>
    </form>
    <button type="button" id="show-local-storage">view local storage</button>
    <!-- Tabulator JS -->
    <script integrity="sha512-8+qwMD/110YLl5T2bPupMbPMXlARhei2mSxerb/0UWZuvcg4NjG7FdxzuuvDs2rBr/KCNqhyBDe8W3ykKB1dzA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"
        src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/6.3.1/js/tabulator.min.js"></script>
    <script>
        // Tabulator setup with AJAX, pagination, and clone button
        var table = new Tabulator("#tabulator-table", {
            ajaxURL: "../assets/ISO-4217.json",
            ajaxConfig: "GET",
            selectable: true,
            columns: [
                {
                    formatter: function (cell, formatterParams, onRendered) {
                        var data = cell.getRow().getData();
                        var row = cell.getRow();
                        setTimeout(function () {
                            var input = row.getElement().querySelector('input[type="checkbox"]');
                            if (input) {
                                input.addEventListener('change', function () {
                                    if (this.checked) {
                                        table.selectRow(row);
                                    } else {
                                        table.deselectRow(row);
                                    }
                                });
                            }
                        }, 10);
                        return `<input name="items[]" type="checkbox" value="${data.code}">`;
                    },
                    hozAlign: "center",
                    title: "Selected",
                    width: 80
                },
                { field: "code", title: "Code", width: 80 },
                { field: "currency", title: "Currency" },
                { field: "digits", title: "Digits", width: 80 },
                { field: "numeric", title: "Numeric", width: 80 },
                { field: "locations", title: "Locations" }
            ],
            layout: "fitColumns",
            pagination: true,
            paginationSize: 10
        });

        // Store form data before pagination change
        var formCache = {};
        function cacheFormData() {
            var inputs = document.querySelectorAll('#tabulator-table input');
            inputs.forEach(function (input) {
                if (input.type === 'checkbox') {
                    formCache[input.value] = formCache[input.value] || {};
                    formCache[input.value].checked = input.checked;
                } else {
                    var name = input.name;
                    formCache[input.value] = formCache[input.value] || {};
                    formCache[input.value][name] = input.value;
                }
            });
        }
        function restoreFormData() {
            var inputs = document.querySelectorAll('#tabulator-table input');
            inputs.forEach(function (input) {
                if (input.type === 'checkbox' && formCache[input.value]) {
                    input.checked = formCache[input.value].checked || false;
                    input.dispatchEvent(new Event('change'));
                } else if (formCache[input.value] && formCache[input.value][input.name]) {
                    input.value = formCache[input.value][input.name];
                }
            });
        }
        function mergeArraysUnique(arr1, arr2) {
            return Array.from(new Set([...(arr1 || []), ...(arr2 || [])]));
        }
        function cacheFormDataToLocalStorage() {
            var form = document.forms['formA'];
            var formData = new FormData(form);
            var obj = {};
            formData.forEach(function (value, key) {
                if (key.endsWith('[]')) {
                    if (!obj[key]) obj[key] = [];
                    obj[key].push(value);
                } else {
                    obj[key] = value;
                }
            });
            // merge with old localStorage
            var old = localStorage.getItem('from_data');
            if (old) {
                var oldObj = JSON.parse(old);
                Object.keys(obj).forEach(function (key) {
                    if (key.endsWith('[]')) {
                        oldObj[key] = mergeArraysUnique(oldObj[key], obj[key]);
                    } else {
                        oldObj[key] = obj[key];
                    }
                });
                localStorage.setItem('from_data', JSON.stringify(oldObj));
            } else {
                localStorage.setItem('from_data', JSON.stringify(obj));
            }
        }



        // Page change events
        function onPagination() {
            cacheFormData();
            cacheFormDataToLocalStorage();
            setTimeout(restoreFormData, 100);
        }
        table.on('pageChanged', function () { alert('Page changed'); onPagination(); });
        table.on('pageLoaded', function (pageno) { alert('Page loaded: ' + pageno); onPagination(); });
        table.on('pageSizeChanged', function (pagesize) { alert('Page size changed: ' + pagesize); onPagination(); });

        // date validation
        var formA = document.forms['formA'];
        var dateFromInput = formA.querySelector('[name="date_from"]');
        var dateToInput = formA.querySelector('[name="date_to"]');
        function validateDate() {
            var from = dateFromInput.value;
            var to = dateToInput.value;
            if (from && to && to < from) {
                dateToInput.setCustomValidity('Date To must be greater than or equal to Date From');
            } else {
                dateToInput.setCustomValidity('');
            }
        }
        dateFromInput.addEventListener('change', validateDate);
        dateToInput.addEventListener('change', validateDate);

        // alert all form data on submit
        document.forms['formA'].addEventListener('submit', function (e) {
            validateDate();
            if (!formA.checkValidity()) {
                alert(dateToInput.validationMessage);
                return;
            }
            e.preventDefault();
            var form = e.target;
            var formData = new FormData(form);
            var entries = [];
            var obj = {};
            formData.forEach(function (value, key) {
                if (key.endsWith('[]')) {
                    if (!obj[key]) obj[key] = [];
                    obj[key].push(value);
                } else {
                    obj[key] = value;
                }
            });
            localStorage.setItem('from_data', JSON.stringify(obj));
            alert(entries.join('\n'));
        });

        // restore form data from localStorage on page load
        window.addEventListener('DOMContentLoaded', function () {
            var saved = localStorage.getItem('from_data');
            if (saved) {
                var obj = JSON.parse(saved);
                var form = document.forms['formA'];
                Object.keys(obj).forEach(function (key) {
                    var val = obj[key];
                    var inputs = form.querySelectorAll('[name="' + key + '"]');
                    if (inputs.length > 1 && Array.isArray(val)) {
                        inputs.forEach(function (input, idx) {
                            if (input.type === 'checkbox') {
                                input.checked = val.includes(input.value);
                                input.dispatchEvent(new Event('change'));
                            } else {
                                input.value = val[idx] || '';
                            }
                        });
                    } else {
                        inputs.forEach(function (input) {
                            if (input.type === 'checkbox') {
                                input.checked = (Array.isArray(val) ? val.includes(input.value) : input.value == val);
                                input.dispatchEvent(new Event('change'));
                            } else {
                                input.value = val;
                            }
                        });
                    }
                });
            }
        });
        document.getElementById('show-local-storage').addEventListener('click', function () {
            var saved = localStorage.getItem('from_data');
            if (saved) {
                alert('form_data\n' + saved);
            } else {
                alert('No form_data found in localStorage');
            }
        });
    </script>
</body>

</html>